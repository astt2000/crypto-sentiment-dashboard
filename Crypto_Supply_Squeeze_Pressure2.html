<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Supply Squeeze Pressure Monitor v4</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
:root{
  --bg:#f6f8fb; --card:#ffffff; --text:#0f1720; --muted:#6b737b; --accent:#0b76d1;
  --good:#1e8a3f; --bad:#d6453a; --neutral:#65707a;
  --good-tint:rgba(30,138,63,0.06); --bad-tint:rgba(214,69,58,0.06); --neutral-tint:rgba(101,112,122,0.04);
  --scale-height:14px;
  font-family: Inter, "Segoe UI", Roboto, Arial, sans-serif;
}
html,body{height:100%;margin:0;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased;}
body.dark{background:#071217;color:#e6eef6}
.app{max-width:1080px;margin:0 auto;padding:10px;}
header{display:flex;flex-wrap:wrap;align-items:center;justify-content:space-between;padding:8px;border-radius:10px;background:rgba(255,255,255,0.92);gap:8px}
body.dark header{background:rgba(6,10,12,0.6)}
.title-row{display:flex;align-items:center;gap:10px}
.title-row h1{margin:0;font-size:1.05rem;color:var(--accent);font-weight:800}
.last-updated{font-size:13px;color:var(--muted);margin-left:6px}
.controls{display:flex;gap:8px;align-items:center}
select,button{padding:6px 8px;border-radius:8px;border:0;cursor:pointer;font-weight:700}
.btn-ghost{background:transparent;border:1px solid rgba(0,0,0,0.06)}
.btn-primary{background:var(--accent);color:#fff}
.tip{font-size:13px;color:var(--muted);margin-top:8px}

/* SSPI scale bar */
.scale-wrap{margin-top:10px;padding:10px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.6),rgba(255,255,255,0.4));box-shadow:0 6px 18px rgba(16,24,40,0.03)}
body.dark .scale-wrap{background:linear-gradient(180deg,rgba(6,10,12,0.6),rgba(6,10,12,0.5))}
.scale{position:relative;height:var(--scale-height);border-radius:10px;overflow:hidden;background:linear-gradient(90deg,#d6453a 0%, #ff9a3d 20%, #b7bfc8 40%, #4fb1b9 60%, #2ea44f 80%);}
.scale-labels{display:flex;justify-content:space-between;font-weight:700;font-size:12px;color:var(--muted);margin-top:6px}
.marker{position:absolute;top:-8px;width:2px;height:calc(var(--scale-height) + 16px);background:#111;border-radius:2px;transform:translateX(-1px);}
.marker-dot{position:absolute;top:-6px;left:-7px;width:14px;height:14px;border-radius:50%;background:#111;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;font-size:11px}
.avg-label{position:absolute;top:-26px;background:rgba(0,0,0,0.06);padding:4px 8px;border-radius:999px;font-weight:800;font-size:12px}

/* grid cards */
.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-top:10px}
@media(max-width:820px){ .grid{grid-template-columns:1fr} }

.card{display:flex;flex-direction:column;gap:6px;padding:10px;border-radius:10px;background:var(--card);box-shadow:0 8px 20px rgba(16,24,40,0.04);font-size:13px}
body.dark .card{background:#0b1216;box-shadow:none}
.card-row{display:flex;justify-content:space-between;align-items:center;gap:8px}
.left{display:flex;align-items:center;gap:8px;min-width:0}
.logo{width:32px;height:32px;border-radius:8px;overflow:hidden;flex:0 0 32px;background:#fff}
.logo img{width:100%;height:100%;object-fit:contain}
.symbol{font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.score-wrap{display:flex;align-items:center;gap:8px}
.score{font-weight:900;font-size:1.05rem;min-width:56px;text-align:right}
.spark-canvas{width:64px;height:12px;border-radius:4px}

/* chip */
.chip{padding:5px 8px;border-radius:999px;font-weight:800;font-size:12px}
.chip.high{background:var(--good-tint);color:var(--good);border:1px solid rgba(30,138,63,0.12)}
.chip.neutral{background:var(--neutral-tint);color:var(--neutral);border:1px solid rgba(101,112,122,0.08)}
.chip.low{background:var(--bad-tint);color:var(--bad);border:1px solid rgba(214,69,58,0.08)}

/* Suggested action text */
.action{font-size:12px;color:var(--muted);line-height:1.15}

/* summary table compact */
.summary-wrap{margin-top:10px;border-radius:10px;overflow:auto;background:rgba(0,0,0,0.02)}
table{width:100%;border-collapse:collapse;font-size:13px}
th,td{padding:8px 10px;text-align:left;border-bottom:1px solid rgba(0,0,0,0.04)}
th{font-weight:800;color:var(--muted);position:sticky;top:0;background:transparent}
tr:hover td{background:rgba(0,0,0,0.02)}
.rank-1 td{background:linear-gradient(90deg, rgba(46,164,79,0.06), rgba(255,255,255,0));}

/* bottom meaning section */
.meaning-box{margin-top:12px;padding:12px;border-radius:10px;background:rgba(0,0,0,0.02);font-size:13px}
.meaning-box b{font-weight:800}
footer{margin-top:10px;text-align:center;font-size:12px;color:var(--muted)}

/* compact mobile tweaks */
@media(max-width:420px){
  .logo{width:28px;height:28px}
  .score{font-size:0.98rem;min-width:48px}
  .spark-canvas{width:56px;height:12px}
}
</style>
</head>
<body>
<div class="app">
  <header>
    <div class="title-row">
      <svg width="36" height="36" viewBox="0 0 24 24" aria-hidden><rect width="24" height="24" rx="5" fill="#0b76d1"/><path d="M5 15l3-6 3 12 3-9 3 6" stroke="#fff" stroke-width="1.1"/></svg>
      <div>
        <h1>Supply Squeeze Pressure Monitor</h1>
        <div class="last-updated" id="lastUpdated">Last updated: -- (Malaysia GMT+8)</div>
      </div>
    </div>

    <div class="controls">
      <label class="small">Auto-refresh</label>
      <select id="refreshSelect" title="Refresh interval">
        <option value="5">5m</option>
        <option value="10">10m</option>
        <option value="30" selected>30m</option>
      </select>
      <button id="refreshNow" class="btn-primary">Refresh</button>
      <button id="themeToggle" class="btn-ghost" title="Toggle theme">ðŸŒ™</button>
    </div>
  </header>

  <div class="tip">Using CoinGecko (free) as proxy. SSPI is an approximate liquidity-tightness index (higher means tighter/less available supply).</div>

  <!-- scale bar -->
  <div class="scale-wrap" aria-hidden>
    <div style="display:flex;align-items:center;justify-content:space-between;gap:8px">
      <div style="font-weight:800">SSPI Scale (0â€“100)</div>
      <div id="avgLabel" style="font-weight:800;color:var(--muted)">Avg SSPI: --</div>
    </div>
    <div style="position:relative;margin-top:8px">
      <div class="scale" id="scaleBar"></div>
      <div id="marker" class="marker" style="left:50%;display:none">
        <div class="marker-dot" id="markerDot">--</div>
      </div>
    </div>
    <div class="scale-labels">
      <div>0 (Abundant)</div>
      <div>20</div>
      <div>40</div>
      <div>60</div>
      <div>80</div>
      <div>100 (Extreme)</div>
    </div>
  </div>

  <!-- grid of cards -->
  <div id="grid" class="grid" aria-live="polite"></div>

  <!-- summary table -->
  <div class="summary-wrap" id="summaryWrap">
    <table id="summaryTable">
      <thead>
        <tr><th style="width:40px">#</th><th>Coin</th><th style="width:86px">SSPI</th><th style="width:110px">Status</th><th>Suggested Action</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- bottom meaning -->
  <div class="meaning-box" id="meaningBox">
    <b>Meaning of SSPI Scores</b>
    <p style="margin:6px 0 0 0;color:var(--muted)">
      SSPI (Supply Squeeze Pressure Index) estimates how tight circulating supply is relative to demand and liquidity using free market proxies.
      Higher values indicate less sellable supply (potential accumulation / squeeze). Use with other research â€” this is a directional proxy.
    </p>
    <table style="width:100%;margin-top:8px">
      <thead><tr><th style="width:120px">Range</th><th>Meaning</th><th>Suggested Market View</th></tr></thead>
      <tbody>
        <tr><td><b>80â€“100</b></td><td>Extreme tightening</td><td>Strong Buy / Accumulate</td></tr>
        <tr><td><b>60â€“79</b></td><td>Moderate squeeze</td><td>Bullish / Hold</td></tr>
        <tr><td><b>40â€“59</b></td><td>Neutral liquidity</td><td>Observe / Wait</td></tr>
        <tr><td><b>20â€“39</b></td><td>Loose supply</td><td>Caution / Partial Exit</td></tr>
        <tr><td><b>0â€“19</b></td><td>Abundant supply</td><td>Exit / Avoid</td></tr>
      </tbody>
    </table>
  </div>

  <footer id="footNote">Built with CoinGecko â€” free data (proxy). Last updated shown above.</footer>
</div>

<script>
/* Supply Squeeze Pressure Monitor v4
   - CoinGecko-only (free)
   - Coins: BTC, ETH, XRP, LINK, ADA, SOL, XLM, HBAR, POL (Polygon), ALGO, RENDER, DOGE
   - SSPI computed from 30d price change proxy + marketcap/volume proxy
   - Tiny inline sparklines via canvas
   - Auto-refresh default 30 minutes (configurable)
   - Shows avg SSPI marker on scale + numeric label
*/

const coins = [
  { id: 'bitcoin', sym: 'BTC' },
  { id: 'ethereum', sym: 'ETH' },
  { id: 'ripple', sym: 'XRP' },
  { id: 'chainlink', sym: 'LINK' },
  { id: 'cardano', sym: 'ADA' },
  { id: 'solana', sym: 'SOL' },
  { id: 'stellar', sym: 'XLM' },
  { id: 'hedera-hashgraph', sym: 'HBAR' },
  { id: 'polygon', sym: 'POL' },
  { id: 'algorand', sym: 'ALGO' },
  { id: 'render-token', sym: 'RENDER' },
  { id: 'dogecoin', sym: 'DOGE' }
];

const DEFAULT_REFRESH_MIN = 30; // 30 minutes
const LS_KEY = 'sspi_v4_cfg';
const cfg = loadCfg();
let refreshTimer = null;

/* -------- Helpers -------- */
function loadCfg(){ try{ const raw = localStorage.getItem(LS_KEY); if(!raw) return { refresh: DEFAULT_REFRESH_MIN, theme: 'light' }; const p = JSON.parse(raw); return { refresh: p.refresh || DEFAULT_REFRESH_MIN, theme: p.theme || 'light' }; }catch(e){ return { refresh: DEFAULT_REFRESH_MIN, theme: 'light' }; } }
function saveCfg(){ localStorage.setItem(LS_KEY, JSON.stringify({ refresh: cfg.refresh, theme: cfg.theme })); }
function malaysiaTime(){ try{ return new Intl.DateTimeFormat('en-GB',{timeZone:'Asia/Kuala_Lumpur',year:'numeric',month:'short',day:'numeric',hour:'2-digit',minute:'2-digit',second:'2-digit'}).format(new Date()); }catch(e){ return new Date().toLocaleString(); } }
async function safeFetch(url, timeout=12000){ try{ const ctrl = new AbortController(); const id = setTimeout(()=>ctrl.abort(), timeout); const res = await fetch(url, { signal: ctrl.signal }); clearTimeout(id); if(!res.ok) return null; return await res.json(); }catch(e){ console.warn('fetch failed', url, e && e.message); return null; } }

/* -------- SSPI computation (CoinGecko proxies) --------
   - illiquid proxy: 30d price change -> normalize -50..50 -> 0..100
   - ssr proxy: marketcap / volume ratio (log10) -> normalize 0..6 -> 0..100
   - final score = illiquid*0.6 + ssr*0.4
*/
function normalizeTo0_100(value, min=-50, max=50){
  if(value === null || value === undefined || isNaN(value)) return null;
  const clamped = Math.max(min, Math.min(max, value));
  return ((clamped - min) / (max - min)) * 100;
}
function computeSSPIFromCG(item){
  const price30 = item.price_change_percentage_30d_in_currency;
  const vol = item.total_volume || 1;
  const mcap = item.market_cap || 1;
  const illiquid = normalizeTo0_100(price30, -50, 50);
  const ratio = Math.log10(Math.max(1, mcap / Math.max(1, vol)));
  const ssr = normalizeTo0_100(ratio, 0, 6);
  if(illiquid === null || ssr === null) return null;
  const score = (illiquid * 0.6) + (ssr * 0.4);
  return Math.round(score);
}

/* -------- UI helpers -------- */
function statusLabel(score){
  if(score === null) return { label: 'N/A', cls: 'chip neutral' };
  if(score >= 70) return { label: 'High', cls: 'chip high' };
  if(score >= 40) return { label: 'Neutral', cls: 'chip neutral' };
  return { label: 'Low', cls: 'chip low' };
}
function actionText(score){
  if(score === null) return 'Data unavailable';
  if(score >= 70) return 'High squeeze pressure â€” accumulation / buy zone.';
  if(score >= 40) return 'Neutral liquidity â€” observe / hold.';
  return 'Low squeeze pressure â€” abundant supply; consider reducing exposure.';
}

/* draw tiny sparkline on canvas (very thin visual) */
function drawTinySpark(canvas, arr){
  if(!canvas || !arr || arr.length < 2) return;
  const ctx = canvas.getContext('2d');
  const DPR = window.devicePixelRatio || 1;
  const w = canvas.clientWidth * DPR;
  const h = canvas.clientHeight * DPR;
  canvas.width = w; canvas.height = h;
  ctx.clearRect(0,0,w,h);
  const min = Math.min(...arr), max = Math.max(...arr);
  const range = (max - min) || 1;
  ctx.lineWidth = Math.max(1, DPR); // 1px visual
  const color = arr[arr.length - 1] > arr[0] ? '#1e8a3f' : (arr[arr.length - 1] < arr[0] ? '#d6453a' : '#97a0ad');
  ctx.strokeStyle = color;
  ctx.beginPath();
  for(let i=0;i<arr.length;i++){
    const x = (i / (arr.length - 1)) * w;
    const y = h - ((arr[i] - min) / range) * h;
    if(i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
  }
  ctx.stroke();
}

/* -------- Fetch & render pipeline -------- */
async function loadDataAndRender(){
  // show loading text
  document.getElementById('lastUpdated').textContent = 'Last updated: fetchingâ€¦';
  const ids = coins.map(c=>c.id).join(',');
  // request sparkline and 30d changes if available
  const url = `https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&ids=${encodeURIComponent(ids)}&order=market_cap_desc&per_page=250&page=1&sparkline=true&price_change_percentage=30d`;
  const markets = await safeFetch(url);
  if(!markets || !Array.isArray(markets) || markets.length === 0){
    document.getElementById('grid').innerHTML = '<div style="padding:12px;color:var(--muted)">Unable to fetch data from CoinGecko. Try again later.</div>';
    document.getElementById('lastUpdated').textContent = 'Last updated: ' + malaysiaTime();
    return;
  }

  // build card grid and summary rows
  const grid = document.getElementById('grid');
  grid.innerHTML = '';
  const rows = [];
  let sum = 0; let count = 0;

  for(const item of markets){
    const sspi = computeSSPIFromCG(item);
    if(sspi !== null && !isNaN(sspi)){ sum += sspi; count++; }
    const status = statusLabel(sspi);
    const card = document.createElement('div'); card.className = 'card';

    // left row
    const row = document.createElement('div'); row.className = 'card-row';
    const left = document.createElement('div'); left.className = 'left';
    const logo = document.createElement('div'); logo.className = 'logo';
    const img = document.createElement('img'); img.src = item.image; img.alt = item.symbol; img.style.width='100%'; img.style.height='100%'; img.style.objectFit='contain';
    logo.appendChild(img);
    const sym = document.createElement('div'); sym.className = 'symbol'; sym.textContent = item.symbol.toUpperCase();
    left.appendChild(logo); left.appendChild(sym);

    // right score + spark + chip
    const right = document.createElement('div'); right.style.display='flex'; right.style.flexDirection='column'; right.style.alignItems='flex-end'; right.style.gap='6px';
    const scoreWrap = document.createElement('div'); scoreWrap.style.display='flex'; scoreWrap.style.alignItems='center'; scoreWrap.className='score-wrap';
    const scoreDiv = document.createElement('div'); scoreDiv.className = 'score'; scoreDiv.textContent = sspi !== null ? sspi : 'N/A';
    const canvas = document.createElement('canvas'); canvas.className = 'spark-canvas';
    scoreWrap.appendChild(scoreDiv); scoreWrap.appendChild(canvas);
    const chip = document.createElement('div'); chip.className = `chip ${status.cls.split(' ')[1]}`; chip.textContent = status.label;
    right.appendChild(scoreWrap); right.appendChild(chip);

    row.appendChild(left); row.appendChild(right);
    card.appendChild(row);

    // action line
    const action = document.createElement('div'); action.className = 'action'; action.textContent = actionText(sspi);
    card.appendChild(action);

    grid.appendChild(card);

    // sparkline from item.sparkline_in_7d.price (if present) or fallback small flat
    const sparkData = item.sparkline_in_7d && item.sparkline_in_7d.price ? item.sparkline_in_7d.price.slice(-30) : null;
    if(sparkData && sparkData.length >= 2){
      // draw after next frame
      requestAnimationFrame(()=> drawTinySpark(canvas, sparkData.map(v=>Number(v))));
    } else {
      // draw small flat line as fallback
      requestAnimationFrame(()=>{
        const ctx = canvas.getContext('2d');
        const DPR = window.devicePixelRatio || 1;
        const w = canvas.clientWidth * DPR;
        const h = canvas.clientHeight * DPR;
        canvas.width = w; canvas.height = h;
        ctx.clearRect(0,0,w,h);
        ctx.strokeStyle = '#97a0ad';
        ctx.lineWidth = Math.max(1, DPR);
        ctx.beginPath(); ctx.moveTo(0, h/2); ctx.lineTo(w, h/2); ctx.stroke();
      });
    }

    rows.push({ id: item.id, symbol: item.symbol.toUpperCase(), sspi: (sspi === null ? -1 : sspi), status: status.label, action: actionText(sspi) });
  }

  // compute average
  const avg = count ? Math.round(sum / count) : null;
  updateScaleMarker(avg);

  // populate summary table sorted by sspi desc (treat -1 as last)
  rows.sort((a,b)=> (b.sspi - a.sspi));
  const tbody = document.querySelector('#summaryTable tbody');
  tbody.innerHTML = '';
  rows.forEach((r, idx) => {
    const tr = document.createElement('tr'); if(idx === 0 && r.sspi >= 0) tr.className = 'rank-1';
    const tdRank = document.createElement('td'); tdRank.textContent = (r.sspi >= 0 ? idx + 1 : '-');
    const tdCoin = document.createElement('td'); tdCoin.textContent = r.symbol;
    const tdSSPI = document.createElement('td'); tdSSPI.textContent = (r.sspi >= 0 ? r.sspi : 'N/A');
    const tdStatus = document.createElement('td'); tdStatus.textContent = r.status;
    const tdAction = document.createElement('td'); tdAction.textContent = r.action;
    tr.appendChild(tdRank); tr.appendChild(tdCoin); tr.appendChild(tdSSPI); tr.appendChild(tdStatus); tr.appendChild(tdAction);
    tbody.appendChild(tr);
  });

  // update last updated text
  document.getElementById('lastUpdated').textContent = 'Last updated: ' + malaysiaTime();
  // avg label
  document.getElementById('avgLabel').textContent = 'Avg SSPI: ' + (avg !== null ? avg : '--');
}

/* update scale marker position and numeric dot */
function updateScaleMarker(avg){
  const marker = document.getElementById('marker');
  const scale = document.getElementById('scaleBar');
  const markerDot = document.getElementById('markerDot');
  if(avg === null || isNaN(avg)){ marker.style.display = 'none'; return; }
  marker.style.display = 'block';
  // compute left percent
  const pct = Math.max(0, Math.min(100, avg));
  marker.style.left = pct + '%';
  markerDot.textContent = avg;
  // move avg label (also set content)
  document.getElementById('avgLabel').textContent = 'Avg SSPI: ' + avg;
}

/* interactions: theme, refresh interval, manual refresh */
document.getElementById('themeToggle').addEventListener('click', ()=>{
  document.body.classList.toggle('dark');
  cfg.theme = document.body.classList.contains('dark') ? 'dark' : 'light';
  saveCfg();
});
document.getElementById('refreshNow').addEventListener('click', ()=> loadDataAndRender());
document.getElementById('refreshSelect').value = cfg.refresh || DEFAULT_REFRESH_MIN;
document.getElementById('refreshSelect').addEventListener('change', (e)=>{
  const m = Number(e.target.value);
  cfg.refresh = m;
  saveCfg();
  if(refreshTimer) clearInterval(refreshTimer);
  refreshTimer = setInterval(loadDataAndRender, m * 60 * 1000);
});

/* start auto-refresh */
(function init(){
  // apply theme from cfg
  if(cfg.theme === 'dark') document.body.classList.add('dark');
  // set up refresh timer
  const minutes = cfg.refresh || DEFAULT_REFRESH_MIN;
  if(refreshTimer) clearInterval(refreshTimer);
  refreshTimer = setInterval(loadDataAndRender, minutes * 60 * 1000);
  // initial load
  loadDataAndRender();
})();

</script>
</body>
</html>
